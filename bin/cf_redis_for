#!/bin/bash

app=$(cf apps | grep -e '\/\d' | cut -d' ' -f1 | fzf +m)

VCAP_SERVICES=$(cf env $app | grep -v "Getting env variables" | grep -v "OK" | grep -v "System-Provided:" | sed '/VCAP_APPLICATION/,$ d' | sed '$ d')
# echo $VCAP_SERVICES
credentials=$(echo $VCAP_SERVICES | jq ".VCAP_SERVICES.redis[0].credentials")
# echo $credentials

host=$(echo $credentials | jq ".host" | tr -d '"')
port=$(echo $credentials | jq ".port")
password=$(echo $credentials | jq ".password" | tr -d '"')

echo "connecting to host: '${host}' port: '${port}' pwd: '${password}'"

docker run --rm -ti --name rediscli \
    --net host \
    redis \
    redis-cli -h ${host} -p ${port} -a ${password}
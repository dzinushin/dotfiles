#!/opt/homebrew/bin/bash
##
## used file with format:
##   <db-name> <db-login.optional> <db-password.password> <db-url.optional>
##
## if optional fields is not defined used value from first line

declare -A lgns
declare -A pwds
declare -A urls

pgdb_file="${HOME}/.pgdb_prod"

echo "using file $pgdb_file"

while read -r key login pwd url; do
  if [[ -n "$key" && ${key:0:1} != "#" ]]; then
    lgns[$key]=$login
    pwds[$key]=$pwd
    urls[$key]=$url
    if [[ -z $"$default_url" ]]; then
      default_url=$url
    fi
    if [[ -z $"$default_login" ]]; then
      default_login=$login
    fi
    if [[ -z $"$default_pwd" ]]; then
      default_pwd=$pwd
    fi
  fi
done < $pgdb_file
#echo ">>>>>>>>>> default $default_login $default_pwd $default_url"

keys=${!lgns[@]}
#echo $keys

app=$(echo $keys | tr " " "\n" | fzf -m)
echo $app

login=${lgns[$app]}
pwd=${pwds[$app]}
url=${urls[$app]}


if [[ -z $"$login" ]]; then
  login=$default_login
fi

if [[ -z $"$pwd" ]]; then
  pwd=$default_pwd
fi

if [[ -z $"$url" ]]; then
  url=$default_url
fi

#echo ">>>>>>>> $app $login:$pwd $url"

conn_str="postgresql://$login@$url/$app?ssl=true&sslmode=verify-full&target_session_attrs=read-write"

# echo "conn_str=\"$conn_str\""
echo ">>>>>>> conn_str=\"$conn_str\""

export PGPASSWORD=$pwd

pgcli "$conn_str"
